version: '3'

vars:
  FULL_PACKAGER_COMMAND: ".venv/bin/python -m poetry"

tasks:
  install-dev:
    desc: Install development dependencies
    cmds:
      - "{{.FULL_PACKAGER_COMMAND}} lock"
      - "{{.FULL_PACKAGER_COMMAND}} install --all-groups"

  install-prod:
    desc: Install production dependencies
    cmds:
      - "{{.FULL_PACKAGER_COMMAND}} install --no-dev"

  initialize-venv:
    desc: Initialize the virtual environment
    cmds:
      - |
        if [ ! -d ".venv" ]; then
          echo "Creating virtual environment at .venv"
          python -m virtualenv --python={{.BACKEND__PYTHON_VERSION}} .venv
          source .venv/bin/activate || . .venv/bin/activate || true
          .venv/bin/python -m pip install --upgrade poetry
          {{.FULL_PACKAGER_COMMAND}} config virtualenvs.path .venv
          {{.FULL_PACKAGER_COMMAND}} config virtualenvs.create false
          {{.FULL_PACKAGER_COMMAND}} config cache-dir {{.RELATIVE_CACHE_PATH}}
          {{.FULL_PACKAGER_COMMAND}} config virtualenvs.in-project true
        fi

  init-project:
    desc: Initialize the project and install dependencies
    cmds:
      - task: initialize-venv
      - task: install-dev
      - task: enable-pre-commit

  lint:
    desc: Run linters and formatters
    cmds:
      - "{{.FULL_PACKAGER_COMMAND}} run ruff check --config pyproject.toml"
      - "{{.FULL_PACKAGER_COMMAND}} run mypy . --config-file pyproject.toml"

  format:
    desc: Format the codebase
    cmds:
      - "{{.FULL_PACKAGER_COMMAND}} run ruff format --config pyproject.toml"
      - "{{.FULL_PACKAGER_COMMAND}} run ruff check --fix --config pyproject.toml >> /dev/null || exit 0"

  test:
    desc: Run tests
    env:
      TESTCONTAINERS_HOST_OVERRIDE: "127.0.0.1"
    cmds:
      - "{{.FULL_PACKAGER_COMMAND}} run pytest --config-file pyproject.toml -svv"

  test-chosen:
    desc: Run tests marked as "chosen"
    env:
      TESTCONTAINERS_HOST_OVERRIDE: "127.0.0.1"
    cmds:
      - "{{.FULL_PACKAGER_COMMAND}} run pytest --config-file pyproject.toml -svv -m 'chosen'"

  test-offline:
    desc: Run tests that can be run offline
    env:
      TESTCONTAINERS_HOST_OVERRIDE: "127.0.0.1"
    cmds:
      - "{{.FULL_PACKAGER_COMMAND}} run pytest --config-file pyproject.toml -svv -m 'offline'"

  start-api:
    desc: Start the API server
    dotenv:
      - .env
    cmds:
      - docker compose -f deploy/docker-compose.yaml up --build 

  build-image:
    desc: Build the local Docker image (no push)
    vars:
      IMAGE_NAME: 'ghcr.io/{{.GITHUB__REPOSITORY | default "kamilrybacki/mtgapi"}}'
      DOCKERFILE: "deploy/Dockerfile"
    cmds:
      - docker build -f {{.DOCKERFILE}} -t {{.IMAGE_NAME}}:local .

  push-image:
    desc: Build and push image to GHCR (requires 'docker login ghcr.io')
    vars:
      IMAGE_NAME: 'ghcr.io/{{.GITHUB__REPOSITORY | default "kamilrybacki/mtgapi"}}'
      DOCKERFILE: "deploy/Dockerfile"
    cmds:
      - docker build -f {{.DOCKERFILE}} -t {{.IMAGE_NAME}}:latest .
      - docker push {{.IMAGE_NAME}}:latest

  docs-build:
    desc: Build MkDocs site into site/
    cmds:
      - "{{.FULL_PACKAGER_COMMAND}} run mkdocs build --strict"

  docs-serve:
    desc: Serve MkDocs with live reload
    cmds:
      - "{{.FULL_PACKAGER_COMMAND}} run mkdocs serve -a 0.0.0.0:8001"

  security-scan:
    desc: Run Bandit security scan
    cmds:
      - "{{.FULL_PACKAGER_COMMAND}} run bandit -q -r src -f screen --exclude tests"

  dependency-audit:
    desc: Run pip-audit on exported requirements
    cmds:
      - "{{.FULL_PACKAGER_COMMAND}} export -f requirements.txt --output requirements.txt --without-hashes"
      - "{{.FULL_PACKAGER_COMMAND}} run pip-audit -r requirements.txt --progress-spinner=off"

  export-schemas:
    desc: Export JSON schemas for domain models
    cmds:
      - "{{.FULL_PACKAGER_COMMAND}} run python scripts/export_schemas.py"

  export-openapi:
    desc: Export OpenAPI schema to docs/_generated_openapi
    cmds:
      - "{{.FULL_PACKAGER_COMMAND}} run python scripts/export_openapi.py"
